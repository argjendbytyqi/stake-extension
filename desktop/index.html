<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: sans-serif; background: #0b1117; color: #c9d1d9; padding: 20px; }
        .status { font-size: 14px; margin-bottom: 20px; }
        .on { color: #238636; }
        .off { color: #da3633; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #161b22; border: 1px solid #30363d; color: white; border-radius: 6px; }
        button { width: 100%; padding: 12px; background: #2f81f7; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .log { margin-top: 20px; font-size: 11px; background: #000; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; border-radius: 4px; }
    </style>
</head>
<body>
    <h2>StakePeek Desktop</h2>
    <div class="status">Status: <span id="status" class="off">● Offline</span></div>
    <input type="text" id="license" placeholder="License Key">
    <input type="text" id="stake-token" placeholder="Stake Session Token">
    <button onclick="start()">Connect & Claim</button>
    
    <div class="log" id="log">StakePeek Hybrid initialized...</div>

    <script>
        const WebSocket = require('ws');
        const fetch = require('node-fetch');

        function log(msg) {
            const div = document.getElementById('log');
            div.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        async function start() {
            const key = document.getElementById('license').value;
            const token = document.getElementById('stake-token').value;
            
            log("Authenticating...");
            const res = await fetch(`http://18.199.98.207:8000/auth/token?license_key=${key}`);
            const data = await res.json();
            
            if (!data.token) {
                log("Invalid License!");
                return;
            }

            const ws = new WebSocket(`ws://18.199.98.207:8000/ws?token=${data.token}`);
            
            ws.on('open', () => {
                document.getElementById('status').className = 'on';
                document.getElementById('status').innerText = '● Online';
                log("WebSocket Connected!");
            });

            ws.on('message', async (msg) => {
                const drop = JSON.parse(msg);
                if (drop.type === 'DROP') {
                    log(`DROP DETECTED: ${drop.code}`);
                    claim(drop.code, token);
                }
            });
        }

        async function claim(code, token) {
            const query = `mutation ClaimBonusCode($code: String!, $currency: CurrencyEnum!, $turnstileToken: String!) {
                claimBonusCode(code: $code, currency: $currency, turnstileToken: $turnstileToken) { ip }
            }`;
            
            const start = Date.now();
            try {
                const res = await fetch('https://stake.com/_api/graphql', {
                    method: 'POST',
                    headers: { 'content-type': 'application/json', 'x-access-token': token },
                    body: JSON.stringify({ query, variables: { code, currency: 'btc', turnstileToken: "" } })
                });
                const time = Date.now() - start;
                log(`Claim sent in ${time}ms`);
                const json = await res.json();
                log(`Result: ${JSON.stringify(json)}`);
            } catch (e) {
                log(`Error: ${e.message}`);
            }
        }
    </script>
</body>
</html>